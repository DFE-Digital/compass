@model FipsReporting.Models.ProductPerformanceFormViewModel

@{
    ViewData["Title"] = $"Performance Reporting - {ViewBag.Month} {ViewBag.Year}";
    ViewData["ActiveNav"] = "reporting";
    ViewData["ActiveNavItem"] = "performance";
}

@section BeforeContent {
    <div class="dfe-masthead dfe-masthead--with-links">
        <div class="govuk-width-container">
            <div class="govuk-grid-row">
                <div class="govuk-grid-column-full">
                    <span class="govuk-caption-l govuk-!-margin-top-6">@ViewBag.Month @ViewBag.Year performance report</span>
                    <h1 class="govuk-heading-xl govuk-!-margin-bottom-5">@Model.Product.Title</h1>
                     <table class="govuk-table">
                        <thead class="govuk-table__head">
                            <tr class="govuk-table__row">
                                <th class="govuk-table__header govuk-!-width-one-quarter">FIPS ID</th>
                                <th class="govuk-table__header govuk-!-width-one-quarter">Phase</th>
                                <th class="govuk-table__header govuk-!-width-one-quarter">Product completion status</th>
                            </tr>
                        </thead>
                        <tbody class="govuk-table__body">
                            <tr class="govuk-table__row">
                                <td class="govuk-table__cell">
                                    <span class="govuk-visually-hidden">FIPS ID: </span>
                                    <span title="@(Model.Product.FipsId)">
                                        @if (!string.IsNullOrWhiteSpace(Model.Product.FipsId))
                                        {
                                           <a href="https://find-products-services-dev.education.gov.uk/product/@Model.Product.FipsId" class="govuk-link">@Model.Product.FipsId</a>
                                        }
                                    </span>
                                </td>
                                <td class="govuk-table__cell">
                                    @{
                                        var phaseIndex = Model.Product.CategoryTypes?.FindIndex(ct => ct == "Phase");
                                        var phaseValue = phaseIndex.HasValue && phaseIndex.Value >= 0 && Model.Product.CategoryValues?.Count > phaseIndex.Value 
                                            ? Model.Product.CategoryValues[phaseIndex.Value] 
                                            : null;
                                    }
                                    @if (!string.IsNullOrWhiteSpace(phaseValue))
                                    {
                                        <span class="govuk-tag govuk-tag--@(phaseValue.ToLower() == "live" ? "green" : phaseValue.ToLower() == "beta" ? "yellow" : phaseValue.ToLower() == "alpha" ? "red" : "grey")">@phaseValue</span>
                                    }
                                    else
                                    {
                                        <span class="govuk-body">Not specified</span>
                                    }
                                </td>
                                <td class="govuk-table__cell">
                                    @{
                                        var completedMetrics = Model.Metrics.Count(m => !string.IsNullOrWhiteSpace(m.Value) || m.IsNullReturn);
                                        var totalMetrics = Model.Metrics.Count;
                                        var completionPercentage = totalMetrics > 0 ? (completedMetrics * 100) / totalMetrics : 0;
                                    }
                                    <span class="govuk-body">@completedMetrics of @totalMetrics</span>
                                    @if (completionPercentage == 100)
                                    {
                                        <span class="govuk-tag govuk-tag--green govuk-!-margin-left-2">Complete</span>
                                    }
                                    else if (completionPercentage > 0)
                                    {
                                        <span class="govuk-tag govuk-tag--yellow govuk-!-margin-left-2">In progress</span>
                                    }
                                    else
                                    {
                                        <span class="govuk-tag govuk-tag--red govuk-!-margin-left-2">Not started</span>
                                    }
                                </td>
                            </tr>
                        </tbody>
                    </table>
                                   </div>
            </div>
        </div>
    </div>
}


        <div class="govuk-grid-row">
            <!-- Vertical Navigation -->
            <div class="govuk-grid-column-one-quarter">
            <a href="@Url.Action("PerformanceByMonth", "Reporting", new { year = Model.Year, month = Model.Month.ToLower() })" class="govuk-back-link govuk-!-margin-top-0">Back to products</a>
               
            
            </div>

            <!-- Main Content -->
            <div class="govuk-grid-column-three-quarters">
                     

                <!-- Performance Metrics Form -->
                <div class="govuk-grid-row">
                    <div class="govuk-grid-column-full">
                        <h2 class="govuk-heading-l">Performance metrics</h2>
                        <p class="govuk-body">Complete the performance metrics for this service for @Model.Month @Model.Year.</p>
                        
                        @if (Model.Metrics.Any())
                        {
                            var groupedMetrics = Model.Metrics.GroupBy(m => m.Category).OrderBy(g => g.Key);
                            
                            foreach (var categoryGroup in groupedMetrics)
                            {
                                <h3 class="govuk-heading-m govuk-!-margin-top-6">@categoryGroup.Key</h3>
                                
                                <ul class="govuk-task-list">
                                    @foreach (var metric in categoryGroup.OrderBy(m => m.Name))
                                    {
                                        var isCompleted = !string.IsNullOrWhiteSpace(metric.Value) || metric.IsNullReturn;
                                        var statusText = isCompleted ? "Completed" : "Not started";
                                        var statusClass = isCompleted ? "" : "govuk-task-list__status--cannot-start";
                                        var valueText = metric.IsNullReturn ? "Null return" : metric.Value;
                                        
                                        <li class="govuk-task-list__item govuk-task-list__item--with-link">
                                            <div class="govuk-task-list__name-and-hint">
                                                <a class="govuk-link govuk-task-list__link" href="@Url.Action("PerformanceMetric", "Reporting", new { year = Model.Year, month = Model.Month.ToLower(), fipsId = Model.Product.FipsId, metricId = metric.UniqueId })" aria-describedby="@metric.UniqueId-status">
                                                    @metric.Name
                                                  
                                                </a>
                                                
                                              
                                                @if (isCompleted && !string.IsNullOrWhiteSpace(valueText))
                                                {
                                                    <div class="govuk-task-list__hint">Value: @valueText</div>
                                                }
                                            </div>
                                            <div class="govuk-task-list__status @statusClass" id="@metric.UniqueId-status">
                                                @if (isCompleted)
                                                {
                                                    <span class="govuk-tag govuk-tag--green">@statusText</span>
                                                }
                                                else
                                                {
                                                    @statusText
                                                }
                                            </div>
                                        </li>
                                    }
                                </ul>
                            }
                            
                            
                        }
                        else
                        {
                            <div class="govuk-inset-text">
                                <p class="govuk-body">No performance metrics are currently configured for this reporting period.</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>